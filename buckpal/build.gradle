import org.jetbrains.kotlin.gradle.tasks.KotlinCompilationTask
import org.jetbrains.kotlin.gradle.dsl.JvmTarget

plugins {
    id "org.jetbrains.kotlin.jvm" version "1.9.23"
    id("com.google.devtools.ksp") version "1.9.23-1.0.19"
    id("groovy")
    id "com.netflix.nebula.facet" version "10.1.5"
    id "idea"
    id("io.micronaut.library") version "4.3.5"
}

micronaut {
    runtime("netty")
    testRuntime("spock2")
}

repositories {
    mavenCentral()
}

facets {
    domain
    domainTest {
        parentSourceSet = "test"
    }
    application
    applicationTest {
        parentSourceSet = "test"
    }
    inboundRest
    inboundRestTest {
        parentSourceSet = "test"
    }
}

dependencies {
    testImplementation "org.jetbrains.kotlin:kotlin-test"
    testImplementation "org.spockframework:spock-core"
    testRuntimeOnly "net.bytebuddy:byte-buddy:1.14.13"
    testRuntimeOnly "org.objenesis:objenesis:3.3"

    domainTestImplementation sourceSets.domain.output

    applicationImplementation sourceSets.domain.output
    applicationImplementation "javax.transaction:javax.transaction-api:1.3"
//    applicationRuntimeOnly "org.jetbrains.kotlinx:kotlinx-coroutines-core:1.8.0"
    applicationTestImplementation sourceSets.domain.output
    applicationTestImplementation sourceSets.application.output
    applicationTestImplementation "org.jetbrains.kotlinx:kotlinx-coroutines-core:1.8.0"

    inboundRestImplementation sourceSets.domain.output
    inboundRestImplementation sourceSets.application.output
    inboundRestImplementation "io.micronaut:micronaut-http-server-netty"
    inboundRestImplementation "io.micronaut:micronaut-jackson-databind"
//    inboundRestImplementation "org.jetbrains.kotlinx:kotlinx-coroutines-core:1.8.0"
    inboundRestTestImplementation sourceSets.domain.output
    inboundRestTestImplementation sourceSets.application.output
    inboundRestTestImplementation "io.micronaut:micronaut-http-client"
    inboundRestTestRuntimeOnly sourceSets.inboundRest.output
    inboundRestTestRuntimeOnly "io.micronaut:micronaut-http-server-netty"
    inboundRestTestRuntimeOnly "io.micronaut:micronaut-jackson-databind"
    inboundRestTestRuntimeOnly "ch.qos.logback:logback-classic"
    inboundRestTestRuntimeOnly "org.jetbrains.kotlinx:kotlinx-coroutines-core:1.8.0"
}

tasks.named('compileKotlin', KotlinCompilationTask) {
    compilerOptions {
        jvmTarget = JvmTarget.JVM_17
        javaParameters = true
    }
}
